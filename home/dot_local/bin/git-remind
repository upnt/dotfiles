#!/usr/bin/bash

if [ -z "$GHUX_ALIASES_PATH" ]; then
        echo 'Please set the "GHUX_ALIASES_PATH"'
        exit 1
fi

if [ ! -f "$GHUX_ALIASES_PATH" ]; then
        /usr/bin/touch "$GHUX_ALIASES_PATH"
fi

_project_list=()
while read -r line; do
        _project_list+=($(eval echo "$line"))
done < <(awk -F, '{print $3}' "$GHUX_ALIASES_PATH")
while read -r line; do
        _project_list+=("$(ghq root)/$line")
done < <(ghq list)

_texts=()

for repo in "${_project_list[@]}"; do
        if [ ! -d "$repo"/.git ]; then
                continue
        fi
        cd "$repo" || continue
        _status=""
        if [ -n "$(git status -s)" ]; then
                _status+="M"
        else
                _status+="-"
        fi
        _texts+=("$_status: $repo")
done

IFS=$'\n'
echo "${_texts[*]}" | fzf --preview="echo {}; ls -l \$(echo {} | awk -F': ' '{print \$2}')" | awk -F': ' '{print $2}'
